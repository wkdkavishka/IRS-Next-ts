#!/usr/bin/env node
/**
 * Deployment Script for Next.js Project
 *
 * This script automates the deployment of a Next.js application to GitHub Pages.
 * It performs the following steps:
 * 1. Optimizes images
 * 2. Generates meta images (favicons, social media images, etc.)
 * 3. Builds the Next.js project
 * 4. Copies the output to the GitHub Pages repository
 * 5. Handles git operations for deployment
 */

import { execSync } from 'child_process';
import { existsSync } from 'fs';
import { join } from 'path';

import { generateMetaImages } from './genMetaImages.ts';

// Main deployment function
async function deploy() {
    try {
        // Target directory where the built files will be deployed
        // Using relative path from the project root
        const TARGET_DIR = join('..', 'IRS-Calculate_Inner_restlessnes_score');
        const SRC_DIR = join(process.cwd(), 'dist');

        // Step 1: Generate meta images (favicons, social media images, etc.)
        console.log('[deploy] Generating meta images...');
        try {
            await generateMetaImages();
            console.log('[deploy] Meta images generated successfully');
        } catch (error) {
            console.warn('[deploy][WARNING] Failed to generate meta images:', error);
        }

        // Step 2: Build the Next.js project
        console.log('[deploy] Building project...');
        runCommand('npm run build');

        // Step 3: Create target directory if it doesn't exist
        console.log('[deploy] Ensuring target directory exists...');
        if (!existsSync(TARGET_DIR)) {
            console.log(`[deploy] Creating target directory: ${TARGET_DIR}`);
            runCommand(`mkdir -p "${TARGET_DIR}"`);
        }

        // Step 4: Copy built files to the GitHub Pages repository
        console.log('[deploy] Copying files to GitHub Pages repo...');
        runCommand(`cp -r "${SRC_DIR}/." "${TARGET_DIR}/"`);

        // Step 5: Stage all changes in the target repository
        console.log('[deploy] Adding changes to git...');
        runCommand('git add .', TARGET_DIR);

        // Step 6: Commit changes with a timestamp
        console.log('[deploy] Committing changes...');
        const timestamp = new Date().toISOString();
        runCommand(`git commit -m "auto deploy ${timestamp}"`, TARGET_DIR);

        // Step 7: Configure git to use rebase when pulling
        console.log('[deploy] Configuring git...');
        runCommand('git config --global pull.rebase true', TARGET_DIR);

        // Step 8: Pull any remote changes to avoid conflicts
        console.log('[deploy] Pulling latest changes...');
        runCommand('git pull', TARGET_DIR);

        // Step 9: Push changes to the remote repository
        console.log('[deploy] Pushing changes...');
        runCommand('git push', TARGET_DIR);

        console.log('[deploy] Deployment completed successfully!');
    } catch (error) {
        // Handle any errors that occur during deployment
        console.error('[deploy][ERROR] Deployment failed:', error);
        process.exit(1);
    }
}

/**
 * Executes a shell command and handles the output and errors.
 * * This function synchronously executes a shell command. It's designed to
 * fail fast by exiting the process on any command failure, making it ideal
 * for scripts where a command's success is a prerequisite for subsequent steps.
 * * @param {string} command The full shell command to execute (e.g., 'npm install').
 * @param {string} [cwd] An optional working directory for the command.
 * @returns {string} The output of the command as a UTF-8 encoded string.
 */
function runCommand(command: string, cwd?: string): string {
    try {
        const options = {
            cwd, // 'cwd' can be undefined which is handled by execSync
            stdio: 'inherit' as const,
            encoding: 'utf-8' as const,
        };

        const output = execSync(command, options);
        return output;
    } catch (error) {
        console.error(`\x1b[31m[ERROR] Command failed: ${command}\x1b[0m`);
        if (error instanceof Error) {
            console.error(`\x1b[31mReason:\x1b[0m ${error.message}`);
        }
        process.exit(1);
    }
}

// Execute the deployment
deploy().catch((error) => {
    console.error('Unhandled error in deployment:', error);
    process.exit(1);
});
